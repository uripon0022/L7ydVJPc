<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MailCopy Helper</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“©</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
   
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
   
  <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
   
  <style>
    /* â–¼â–¼â–¼ ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼å¤‰æ•°å®šç¾© â–¼â–¼â–¼ */
    :root {
      --theme-main: #16a34a;  /* main */
      --theme-soft: #ecfdf5;  /* soft */
      --theme-border: #86efac; /* border */
      --theme-hover: #15803d; /* hover */
      
      --base-font-size: 16px; /* åŸºæœ¬ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
    }

    body { font-family: 'M PLUS Rounded 1c', sans-serif; }
    
    #editor { 
      height: 60vh; 
      font-family: 'M PLUS Rounded 1c', sans-serif;
    }
    
    /* ã‚¨ãƒ‡ã‚£ã‚¿å†…ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºé©ç”¨ */
    #editor .ql-editor {
      font-size: var(--base-font-size);
      line-height: 1.8;
    }
    
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .ql-toolbar.ql-snow {
      border: none;
      background-color: #fff;
      border-bottom: 2px solid var(--theme-soft);
      border-radius: 12px 12px 0 0;
      padding: 8px;
    }
    .ql-container.ql-snow {
      border: none;
      background-color: white;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }

    /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
    .nav-item { 
      @apply p-3 mb-2 rounded-lg cursor-pointer transition border-l-4 border-transparent hover:bg-[var(--theme-soft)] relative flex justify-between items-center; 
      border-bottom: 1px solid var(--theme-soft);
    }
    .nav-item.selected { 
      background-color: var(--theme-soft);
      border-left-color: var(--theme-main);
      font-weight: bold;
    }

    /* å¹´æœˆã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ */
    .month-header {
      @apply text-xs font-bold text-gray-400 mt-4 mb-2 pl-2 border-b border-gray-100 pb-1;
    }
    
    /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
    #toast-container {
      position: fixed;
      bottom: 80px; 
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background-color: rgba(50, 50, 50, 0.95);
      color: white;
      padding: 12px 30px;
      border-radius: 50px;
      font-size: 0.95rem;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      opacity: 0;
      transition: opacity 0.3s, transform 0.3s;
      pointer-events: none;
      z-index: 9999;
    }
    #toast-container.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: var(--theme-border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--theme-main); }
    
    /* ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    .tab-active {
      color: var(--theme-main);
      border-bottom-width: 2px;
      border-bottom-color: var(--theme-main);
      background-color: var(--theme-soft);
    }
    .tab-inactive {
      color: #9ca3af; /* gray-400 */
    }
    .tab-inactive:hover {
      color: var(--theme-main);
      background-color: var(--theme-soft);
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ¶å¾¡ */
    .sidebar-open { transform: translateX(0) !important; }
    .overlay-open { display: block !important; }
  </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col text-gray-700 overflow-hidden">

  <div id="toast-container">é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
  <input type="file" id="import-file" style="display: none;" accept=".json" onchange="importData(this)">

  <header class="bg-white/80 backdrop-blur-md shadow-sm p-3 md:p-4 flex justify-between items-center z-20 border-b border-[var(--theme-border)] transition-colors duration-300">
    <div class="flex items-center gap-2 md:gap-4 overflow-hidden">
      <button onclick="toggleSidebar()" class="md:hidden text-2xl text-[var(--theme-main)] p-1">
        â˜°
      </button>
      
      <h1 class="text-lg md:text-xl font-bold text-[var(--theme-main)] flex items-center gap-2 truncate">
        ğŸ“© <span class="hidden md:inline">MailCopy Helper</span> <span class="md:hidden">MailHelper</span>
      </h1>
      <div id="status-msg" class="text-xs md:text-sm font-bold text-[var(--theme-main)] transition-opacity duration-700 opacity-0 ml-1 whitespace-nowrap"></div>
    </div>
    
    <div class="flex gap-1 md:gap-2 shrink-0">
      <button onclick="setTheme('pink')" class="w-5 h-5 md:w-6 md:h-6 rounded-full bg-pink-500 border-2 border-white shadow hover:scale-110 transition"></button>
      <button onclick="setTheme('blue')" class="w-5 h-5 md:w-6 md:h-6 rounded-full bg-blue-500 border-2 border-white shadow hover:scale-110 transition"></button>
      <button onclick="setTheme('green')" class="w-5 h-5 md:w-6 md:h-6 rounded-full bg-green-600 border-2 border-white shadow hover:scale-110 transition"></button>
      <button onclick="setTheme('black')" class="w-5 h-5 md:w-6 md:h-6 rounded-full bg-gray-800 border-2 border-white shadow hover:scale-110 transition"></button>
    </div>
  </header>

  <div class="flex flex-1 overflow-hidden relative">
    
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity"></div>

    <aside id="left-sidebar" class="fixed md:relative inset-y-0 left-0 z-40 w-4/5 md:w-1/3 max-w-sm bg-white border-r border-[var(--theme-border)] flex flex-col shadow-2xl md:shadow-[4px_0_24px_rgba(0,0,0,0.02)] transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
      <div class="flex border-b border-[var(--theme-border)]">
        <button id="tab-drafts" onclick="switchTab('drafts')" class="flex-1 py-3 text-center font-bold transition duration-300">
          ğŸ“ ä¸‹æ›¸ã
        </button>
        <button id="tab-settings" onclick="switchTab('settings')" class="flex-1 py-3 text-center font-bold transition duration-300">
          âš™ï¸ è¨­å®š
        </button>
        <button onclick="toggleSidebar()" class="md:hidden px-4 text-gray-400">âœ•</button>
      </div>

      <div id="ctrl-drafts" class="p-4 border-b border-[var(--theme-border)] bg-white space-y-3">
        <div class="relative">
          <input type="text" id="search-input" placeholder="ğŸ” æ¤œç´¢..." 
            class="w-full bg-gray-100 border-none rounded-full py-2 px-4 text-sm focus:ring-2 focus:ring-[var(--theme-border)] outline-none transition">
        </div>
        <button onclick="createNew()" class="w-full bg-white border-2 border-[var(--theme-main)] text-[var(--theme-main)] hover:bg-[var(--theme-soft)] font-bold py-2 px-4 rounded-xl shadow-sm transition transform hover:-translate-y-0.5">
          ï¼‹ æ–°è¦ä½œæˆ
        </button>
        <button onclick="downloadAllDraftsAsZip()" class="w-full bg-white border border-gray-300 text-gray-500 font-bold py-2 px-4 rounded-xl hover:bg-gray-100 transition text-sm flex justify-center items-center gap-2">
          ğŸ“¦ Zipä¿å­˜
        </button>
        
        <div class="flex gap-2 pt-2 border-t border-dashed border-gray-200">
          <button onclick="exportData()" class="flex-1 bg-gray-50 border border-gray-300 text-gray-500 text-xs font-bold py-2 px-2 rounded-lg hover:bg-gray-100 transition">
            ğŸ“¤ ä¿å­˜
          </button>
          <button onclick="document.getElementById('import-file').click()" class="flex-1 bg-gray-50 border border-gray-300 text-gray-500 text-xs font-bold py-2 px-2 rounded-lg hover:bg-gray-100 transition">
            ğŸ“¥ å¾©å…ƒ
          </button>
        </div>
      </div>

      <div id="ctrl-settings" class="p-4 border-b border-[var(--theme-border)] bg-white hidden flex flex-col gap-4">
        
        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
          <label class="block text-xs font-bold text-gray-500 mb-2">ğŸ”  åŸºæœ¬æ–‡å­—ã‚µã‚¤ã‚º (å›ºå®š)</label>
          <select id="select-font-size" onchange="changeBaseFontSize(this.value)" class="w-full p-2 bg-white border border-gray-300 rounded-lg text-gray-700 font-bold text-sm focus:outline-none focus:border-[var(--theme-main)]">
            <option value="12px">12px (å°)</option>
            <option value="14px">14px</option>
            <option value="16px" selected>16px (æ¨™æº–)</option>
            <option value="18px">18px (å¤§)</option>
            <option value="20px">20px (ç‰¹å¤§)</option>
            <option value="24px">24px</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button onclick="createHF('header')" class="flex-1 bg-blue-50 text-blue-600 border border-blue-200 font-bold py-2 px-2 rounded-lg hover:bg-blue-100 text-sm">
            ï¼‹ãƒ˜ãƒƒãƒ€ãƒ¼
          </button>
          <button onclick="createHF('footer')" class="flex-1 bg-green-50 text-green-600 border border-green-200 font-bold py-2 px-2 rounded-lg hover:bg-green-100 text-sm">
            ï¼‹ãƒ•ãƒƒã‚¿ãƒ¼
          </button>
        </div>
      </div>

      <div id="list-container" class="flex-1 overflow-y-auto p-4 pb-20 md:pb-4"></div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden bg-[var(--theme-soft)] transition-colors duration-300 w-full relative">
      
      <div class="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col gap-4 pb-24 md:pb-8" id="main-area">
        
        <div id="mode-indicator" class="hidden text-center py-2 rounded-lg font-bold text-white mb-2 shadow-sm text-sm"></div>

        <div id="selector-wrapper" class="flex flex-col md:flex-row gap-2 md:gap-4 p-3 md:p-4 bg-white rounded-2xl shadow-sm border border-[var(--theme-border)]">
          <div class="flex-1">
            <label class="block text-xs font-bold text-[var(--theme-main)] mb-1 ml-1">ğŸ‘‘ ãƒ˜ãƒƒãƒ€ãƒ¼</label>
            <select id="select-header" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-bold text-sm focus:outline-none focus:border-[var(--theme-main)]">
              <option value="">ï¼ˆé¸æŠãªã—ï¼‰</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ğŸ‘£ ãƒ•ãƒƒã‚¿ãƒ¼</label>
            <select id="select-footer" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-bold text-sm focus:outline-none focus:border-gray-400">
              <option value="">ï¼ˆé¸æŠãªã—ï¼‰</option>
            </select>
          </div>
          <div class="flex-1">
            <label class="block text-xs font-bold text-orange-400 mb-1 ml-1">ğŸ—£ï¸ åå‰å¤‰æ›</label>
            <select id="select-name-convert" class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-bold text-sm focus:outline-none focus:border-orange-400">
              <option value="convert">ã€Œã‚ãªãŸã€â†’ {{nickname}}ã•ã‚“</option>
              <option value="none">å¤‰æ›ã—ãªã„</option>
            </select>
          </div>
        </div>

        <div id="hf-name-wrapper" class="hidden">
          <label class="text-sm font-bold text-gray-500">è¨­å®šå</label>
          <input type="text" id="input-hf-name" 
            class="w-full text-lg font-bold border-b-2 border-gray-200 py-1 px-1 focus:outline-none focus:border-[var(--theme-main)] bg-transparent" 
            placeholder="åå‰ã‚’å…¥åŠ›">
        </div>

        <div id="subject-wrapper">
          <input type="text" id="input-subject" 
            class="w-full text-lg md:text-xl font-bold placeholder-[var(--theme-border)] text-gray-700 border-b-2 border-[var(--theme-border)] py-2 px-1 focus:outline-none focus:border-[var(--theme-main)] transition bg-transparent" 
            placeholder="ä»¶åã‚’å…¥åŠ›">
        </div>

        <div class="flex-1 flex flex-col relative pb-8">
          <div id="editor-wrapper" class="">
            <div id="editor"></div>
          </div>
        </div>
      </div>
    </main>

    <div id="right-sidebar" class="hidden md:flex w-48 bg-white/60 border-l border-[var(--theme-border)] p-4 flex-col backdrop-blur-sm z-10 overflow-y-auto">
      <div class="flex flex-col gap-3 w-full pt-4">
        <button id="btn-text-copy" onclick="copyTextOnly()" class="w-full bg-white border-2 border-gray-400 text-gray-600 hover:bg-gray-50 font-bold py-3 px-2 rounded-xl shadow transition transform hover:scale-105 flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
          <span class="text-sm">ãƒ†ã‚­ã‚¹ãƒˆ<br>ã‚³ãƒ”ãƒ¼</span>
        </button>
        <button id="btn-wp" onclick="copyBodyOnly()" class="w-full bg-white border-2 border-blue-400 text-blue-500 hover:bg-blue-50 font-bold py-3 px-2 rounded-xl shadow transition transform hover:scale-105 flex items-center justify-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
          <span class="text-sm">WPã«<br>ã‚³ãƒ”ãƒ¼</span>
        </button>
        <button id="btn-copy" onclick="copyHtml()" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-2 rounded-xl shadow-lg transition transform hover:scale-105 flex flex-col items-center justify-center gap-1">
          <div class="text-[10px] font-normal opacity-80">7th-mailç”¨</div>
          <div class="text-sm font-bold flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
            HTMLã‚³ãƒ”ãƒ¼
          </div>
        </button>
        
        <div class="relative w-full flex flex-col items-center mt-4 pt-4 border-t border-gray-200">
           <button id="btn-duplicate" onclick="duplicateCurrentItem()" class="hidden w-full bg-white border-2 border-cyan-400 hover:bg-cyan-50 text-cyan-600 font-bold py-2 px-2 rounded-xl shadow transition transform hover:scale-105 flex items-center justify-center gap-2 mb-2">
            è¤‡è£½
          </button>
          
          <button id="btn-delete" onclick="deleteCurrentItem()" class="hidden w-full bg-white border-2 border-red-200 hover:bg-red-50 text-red-500 font-bold py-2 px-2 rounded-xl shadow transition transform hover:scale-105 flex items-center justify-center gap-2">
            å‰Šé™¤
          </button>
          
          <div id="action-confirm-msg" class="hidden absolute top-full mt-2 w-48 text-center font-bold text-xs bg-white p-2 rounded-lg border shadow-md animate-pulse z-20">
             </div>
        </div>
      </div>
    </div>

  </div>

  <div id="mobile-toolbar" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 flex gap-2 z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.1)]">
    <button onclick="copyTextOnly()" class="flex-1 bg-white border-2 border-gray-400 text-gray-600 font-bold py-2 rounded-lg text-xs flex flex-col items-center justify-center">
      ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆ
    </button>
    <button onclick="copyHtml()" class="flex-1 bg-[var(--theme-main)] text-white font-bold py-2 rounded-lg text-xs flex flex-col items-center justify-center">
      ğŸ“© HTML
    </button>
    <button onclick="duplicateCurrentItem()" id="btn-duplicate-mobile" class="w-12 bg-cyan-50 border border-cyan-200 text-cyan-600 font-bold py-2 rounded-lg text-xs flex items-center justify-center hidden">
      è¤‡è£½
    </button>
    <button onclick="deleteCurrentItem()" id="btn-delete-mobile" class="w-12 bg-red-50 border border-red-200 text-red-500 font-bold py-2 rounded-lg text-xs flex items-center justify-center hidden">
      å‰Šé™¤
    </button>
  </div>

  <script>
    // --- 0. ãƒ†ãƒ¼ãƒã¨ãƒ•ã‚©ãƒ³ãƒˆç®¡ç† ---
    const themes = {
      green: { main: '#16a34a', soft: '#ecfdf5', border: '#86efac', hover: '#15803d' },
      pink: { main: '#ec4899', soft: '#fdf2f8', border: '#fbcfe8', hover: '#db2777' },
      blue: { main: '#3b82f6', soft: '#eff6ff', border: '#bfdbfe', hover: '#2563eb' },
      black: { main: '#111827', soft: '#f3f4f6', border: '#d1d5db', hover: '#374151' }
    };

    function setTheme(name) {
      const t = themes[name];
      const root = document.documentElement;
      root.style.setProperty('--theme-main', t.main);
      root.style.setProperty('--theme-soft', t.soft);
      root.style.setProperty('--theme-border', t.border);
      root.style.setProperty('--theme-hover', t.hover);
      localStorage.setItem('editor-theme', name);
    }

    function changeBaseFontSize(size) {
      document.documentElement.style.setProperty('--base-font-size', size);
      localStorage.setItem('editor-font-size', size);
    }

    // åˆæœŸåŒ–
    const savedTheme = localStorage.getItem('editor-theme') || 'pink';
    setTheme(savedTheme);

    const savedFontSize = localStorage.getItem('editor-font-size') || '16px';
    document.documentElement.style.setProperty('--base-font-size', savedFontSize);
    document.getElementById('select-font-size').value = savedFontSize;


    // --- 1. åˆæœŸè¨­å®š ---
    const Size = Quill.import('attributors/style/size');
    Size.whitelist = ['10px', '11px', '12px', '13px', '14px', '16px', '18px', '20px', '24px', '36px', '40px', '48px'];
    Quill.register(Size, true);

    const db = new Dexie("MailEditorDB");
    db.version(8).stores({
      drafts: '++id, subject, content, sortDate, updatedAt, createdAt', 
      headers: '++id, name, content, sortDate, updatedAt, createdAt',
      footers: '++id, name, content, sortDate, updatedAt, createdAt'
    });

    // --- 2. ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼è¨­å®š ---
    function imageHandler() {
      const range = this.quill.getSelection();
      const value = prompt('ç”»åƒã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
      if(value) this.quill.insertEmbed(range.index, 'image', value, Quill.sources.USER);
    }

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        imageResize: { displaySize: true },
        toolbar: {
          container: [
            [{ 'size': Size.whitelist }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'align': [] }, { 'indent': '-1'}, { 'indent': '+1' }],
            [{ 'header': 1 }, { 'header': 2 }, 'blockquote'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link', 'image', 'clean']
          ],
          handlers: { 'image': imageHandler }
        }
      }
    });

    setTimeout(() => {
      const sizeLabels = {
        '10px': '10px', '11px': '11px', '12px': '12px', '13px': '13px', 
        '14px': '14px', '16px': '16px (æ¨™æº–)', '18px': '18px', '20px': '20px',
        '24px': '24px (å¤§)', '36px': '36px', '40px': '40px (ç‰¹å¤§)', '48px': '48px'
      };
      const picker = document.querySelector('.ql-size .ql-picker-options');
      if(picker) {
        picker.querySelectorAll('span').forEach(span => {
          const val = span.getAttribute('data-value');
          if(sizeLabels[val]) span.textContent = sizeLabels[val];
        });
      }
      const label = document.querySelector('.ql-size .ql-picker-label');
      if(label) label.setAttribute('data-value', '16px');
    }, 500);

    // --- 3. å¤‰æ•° & å¤‰æ›´æ¤œçŸ¥ç”¨Snapshot ---
    let currentId = null;
    let activeTab = 'drafts'; 
    let editMode = 'draft';
    let autoSaveTimer = null;
    let deletePending = false; 
    let duplicatePending = false; 
    
    // â˜…â˜…â˜… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨å¤‰æ•° (ã“ã“ãŒé‡è¦ï¼) â˜…â˜…â˜…
    let cachedHeaderContent = '';
    let cachedFooterContent = '';
    
    let lastSavedSnapshot = { subject: '', content: '', name: '' };

    // --- 4. ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ ---
    function showToast(message) {
      const toast = document.getElementById('toast-container');
      toast.textContent = message;
      toast.classList.add('show');
      if (window.toastTimer) clearTimeout(window.toastTimer);
      window.toastTimer = setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // --- 5. UIçŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ ---
    function resetActionStates() {
      deletePending = false;
      duplicatePending = false;

      const msg = document.getElementById('action-confirm-msg');
      msg.classList.add('hidden');
      msg.className = "hidden absolute top-full mt-2 w-48 text-center font-bold text-xs bg-white p-2 rounded-lg border shadow-md animate-pulse z-20"; 

      const btnDel = document.getElementById('btn-delete');
      const btnDelMob = document.getElementById('btn-delete-mobile');
      btnDel.classList.remove('bg-red-50', 'border-red-400');
      btnDelMob.classList.remove('bg-red-500', 'text-white');
      btnDelMob.textContent = 'å‰Šé™¤';

      const btnDup = document.getElementById('btn-duplicate');
      const btnDupMob = document.getElementById('btn-duplicate-mobile');
      btnDup.classList.remove('bg-cyan-100', 'border-cyan-500');
      btnDup.textContent = 'è¤‡è£½';
      btnDupMob.classList.remove('bg-cyan-500', 'text-white');
      btnDupMob.textContent = 'è¤‡è£½';
    }

    // --- 6. ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
    async function switchTab(tabName) {
      activeTab = tabName;
      resetActionStates(); 

      if(tabName === 'drafts' && editMode !== 'draft') createNew(); 

      const btnDrafts = document.getElementById('tab-drafts');
      const btnSettings = document.getElementById('tab-settings');
      const ctrlDrafts = document.getElementById('ctrl-drafts');
      const ctrlSettings = document.getElementById('ctrl-settings');

      if(tabName === 'drafts') {
        btnDrafts.className = "flex-1 py-3 text-center font-bold transition duration-300 tab-active";
        btnSettings.className = "flex-1 py-3 text-center font-bold transition duration-300 tab-inactive";
        ctrlDrafts.classList.remove('hidden');
        ctrlSettings.classList.add('hidden');
        loadDraftList();
      } else {
        btnSettings.className = "flex-1 py-3 text-center font-bold transition duration-300 tab-active";
        btnDrafts.className = "flex-1 py-3 text-center font-bold transition duration-300 tab-inactive";
        ctrlSettings.classList.remove('hidden');
        ctrlDrafts.classList.add('hidden');
        loadSettingsList();
      }
    }

    // --- 7. ãƒªã‚¹ãƒˆæç”» ---
    function formatDate(isoStr) {
      if(!isoStr) return '';
      const d = new Date(isoStr);
      const year = d.getFullYear();
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const hour = d.getHours().toString().padStart(2, '0');
      const min = d.getMinutes().toString().padStart(2, '0');
      return `${year}/${month}/${day} ${hour}:${min}`;
    }

    function sortByCreatedAt(list) {
      return list.sort((a, b) => {
        const dateA = a.createdAt || a.sortDate || '';
        const dateB = b.createdAt || b.sortDate || '';
        return dateA < dateB ? 1 : -1; 
      });
    }

    async function loadDraftList() {
      let keyword = document.getElementById('search-input').value.toLowerCase().trim();
      const safeKeyword = keyword.replace(/\s+/g, '');

      let drafts = await db.drafts.toArray();
      drafts = sortByCreatedAt(drafts);
      
      if (safeKeyword) {
        drafts = drafts.filter(d => {
          const tmpDiv = document.createElement('div');
          tmpDiv.innerHTML = d.content;
          const bodyText = (tmpDiv.textContent || tmpDiv.innerText || '').toLowerCase().replace(/\s+/g, '');
          const subj = (d.subject || '').toLowerCase().replace(/\s+/g, '');
          return subj.includes(safeKeyword) || bodyText.includes(safeKeyword);
        });
      }

      const listEl = document.getElementById('list-container');
      listEl.innerHTML = '';

      if (drafts.length === 0) {
        listEl.innerHTML = `<div class="p-4 text-sm text-gray-400 text-center">è©²å½“ãªã—</div>`;
      }

      // å¹´æœˆã”ã¨ã®ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°è¡¨ç¤º
      let lastMonthStr = '';

      drafts.forEach(item => {
        const targetDate = item.createdAt || item.sortDate;
        if(targetDate) {
           const d = new Date(targetDate);
           const currentMonthStr = `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;

           if (currentMonthStr !== lastMonthStr) {
             const headerDiv = document.createElement('div');
             headerDiv.className = 'month-header';
             headerDiv.textContent = currentMonthStr;
             listEl.appendChild(headerDiv);
             lastMonthStr = currentMonthStr;
           }
        }

        const div = document.createElement('div');
        const isSelected = (editMode === 'draft' && currentId === item.id);
        div.className = `nav-item ${isSelected ? 'selected' : ''}`;
        
        const dateStr = formatDate(targetDate);

        div.innerHTML = `
          <div class="flex-1 min-w-0">
            <div class="font-bold text-gray-700 truncate">${item.subject || '(ç„¡é¡Œ)'}</div>
            <div class="text-xs text-gray-400 mt-1">${dateStr}</div>
          </div>
        `;
        div.onclick = () => {
          loadDraft(item.id);
          if(window.innerWidth < 768) toggleSidebar();
        };
        listEl.appendChild(div);
      });
      updateDropdowns();
    }

    async function loadSettingsList() {
      let headers = await db.headers.toArray();
      let footers = await db.footers.toArray();
      
      headers = sortByCreatedAt(headers);
      footers = sortByCreatedAt(footers);

      const listEl = document.getElementById('list-container');
      listEl.innerHTML = '';

      const hTitle = document.createElement('div');
      hTitle.className = "p-2 mb-2 bg-blue-50 text-blue-500 font-bold text-xs uppercase tracking-wider rounded"; 
      hTitle.textContent = "ğŸ‘‘ ãƒ˜ãƒƒãƒ€ãƒ¼ä¸€è¦§";
      listEl.appendChild(hTitle);
      headers.forEach(h => createHFListItem(h, 'header', listEl));

      const fTitle = document.createElement('div');
      fTitle.className = "p-2 mt-6 mb-2 bg-green-50 text-green-500 font-bold text-xs uppercase tracking-wider rounded"; 
      fTitle.textContent = "ğŸ‘£ ãƒ•ãƒƒã‚¿ãƒ¼ä¸€è¦§";
      listEl.appendChild(fTitle);
      footers.forEach(f => createHFListItem(f, 'footer', listEl));
    }

    function createHFListItem(item, type, container) {
      const div = document.createElement('div');
      const isEditing = (editMode === type && currentId === item.id);
      div.className = `nav-item ${isEditing ? 'bg-yellow-50 border-yellow-300' : ''}`;
      
      const targetDate = item.createdAt || item.sortDate;
      const dateStr = formatDate(targetDate);

      div.innerHTML = `
        <div class="flex-1 min-w-0">
          <div class="font-bold text-gray-700 text-sm truncate">${item.name}</div>
          <div class="text-xs text-gray-400 mt-1">${dateStr}</div>
        </div>
      `;
      div.onclick = () => {
        loadHFEditor(type, item.id);
        if(window.innerWidth < 768) toggleSidebar();
      };
      container.appendChild(div);
    }

    // --- 8. ç·¨é›†ãƒ»ä½œæˆãƒ»å‰Šé™¤ UIåˆ¶å¾¡ ---
    function setEditorUI(mode, hasId = false) {
      editMode = mode;
      const wrapper = document.getElementById('editor-wrapper');
      const indicator = document.getElementById('mode-indicator');
      const subjectWrap = document.getElementById('subject-wrapper');
      const hfNameWrap = document.getElementById('hf-name-wrapper');
      const selectorWrap = document.getElementById('selector-wrapper');
      
      const btnCopy = document.getElementById('btn-copy');
      const btnWp = document.getElementById('btn-wp');
      const btnTextCopy = document.getElementById('btn-text-copy');
      
      const btnDelete = document.getElementById('btn-delete');
      const btnDeleteMobile = document.getElementById('btn-delete-mobile');
      const btnDuplicate = document.getElementById('btn-duplicate');
      const btnDuplicateMobile = document.getElementById('btn-duplicate-mobile');

      wrapper.className = ''; 
      subjectWrap.style.display = 'none';
      hfNameWrap.style.display = 'none';
      selectorWrap.style.display = 'none'; 
      indicator.className = 'hidden';

      if (hasId) {
        btnDelete.classList.remove('hidden');
        btnDeleteMobile.classList.remove('hidden');
        btnDuplicate.classList.remove('hidden');
        btnDuplicateMobile.classList.remove('hidden');
      } else {
        btnDelete.classList.add('hidden');
        btnDeleteMobile.classList.add('hidden');
        btnDuplicate.classList.add('hidden');
        btnDuplicateMobile.classList.add('hidden');
      }

      if(mode === 'draft') {
        subjectWrap.style.display = 'block';
        selectorWrap.style.display = 'flex'; 
        btnCopy.classList.remove('hidden');
        btnWp.classList.remove('hidden'); 
        btnTextCopy.classList.remove('hidden');
      } else {
        btnCopy.classList.add('hidden');
        btnWp.classList.add('hidden'); 
        btnTextCopy.classList.add('hidden');
        
        if(mode === 'header') {
          wrapper.classList.add('mode-header');
          hfNameWrap.style.display = 'block';
          indicator.textContent = 'ğŸ‘‘ ãƒ˜ãƒƒãƒ€ãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
          indicator.className = 'block bg-blue-400 text-white text-center py-1 rounded mb-2 text-sm';
        } else if(mode === 'footer') {
          wrapper.classList.add('mode-footer');
          hfNameWrap.style.display = 'block';
          indicator.textContent = 'ğŸ‘£ ãƒ•ãƒƒã‚¿ãƒ¼ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
          indicator.className = 'block bg-green-500 text-white text-center py-1 rounded mb-2 text-sm';
        }
      }
    }

    // --- ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚µã‚¤ãƒ‰ãƒãƒ¼åˆ‡æ›¿ ---
    function toggleSidebar() {
      const sidebar = document.getElementById('left-sidebar');
      const overlay = document.getElementById('mobile-overlay');
      sidebar.classList.toggle('sidebar-open');
      overlay.classList.toggle('overlay-open');
    }

    // --- æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ ---

    function createNew() {
      currentId = null;
      resetActionStates();
      setEditorUI('draft', false);
      document.getElementById('input-subject').value = '';
      quill.root.innerHTML = ''; 
      
      lastSavedSnapshot = { subject: '', content: '', name: '' };
      updateHeaderStatus('', false); 
      
      loadDraftList();
      if(window.innerWidth < 768) toggleSidebar();
    }

    async function loadDraft(id) {
      resetActionStates();
      const draft = await db.drafts.get(id);
      if (draft) {
        currentId = draft.id;
        document.getElementById('input-subject').value = draft.subject;
        quill.root.innerHTML = draft.content;
        
        lastSavedSnapshot = { 
          subject: draft.subject, 
          content: draft.content,
          name: '' 
        };
        updateHeaderStatus('', false);
        
        setEditorUI('draft', true); 
        loadDraftList(); 
      }
    }

    function createHF(type) {
      currentId = null;
      resetActionStates();
      setEditorUI(type, false);
      document.getElementById('input-hf-name').value = '';
      quill.root.innerHTML = '';
      lastSavedSnapshot = { subject: '', content: '', name: '' };
      updateHeaderStatus('', false);
      loadSettingsList();
      showToast(type === 'header' ? 'ğŸ‘‘ æ–°ã—ã„ãƒ˜ãƒƒãƒ€ãƒ¼' : 'ğŸ‘£ æ–°ã—ã„ãƒ•ãƒƒã‚¿ãƒ¼');
      if(window.innerWidth < 768) toggleSidebar();
    }

    async function loadHFEditor(type, id) {
      resetActionStates();
      const table = type === 'header' ? db.headers : db.footers;
      const item = await table.get(id);
      if(item) {
        currentId = item.id;
        setEditorUI(type, true); 
        document.getElementById('input-hf-name').value = item.name;
        quill.root.innerHTML = item.content;
        
        lastSavedSnapshot = {
          subject: '',
          content: item.content,
          name: item.name
        };
        updateHeaderStatus('', false);
        
        loadSettingsList();
      }
    }

    // --- å‰Šé™¤ãƒ»è¤‡è£½å‡¦ç† ---
    async function deleteCurrentItem() {
      if(!currentId) return;

      if(duplicatePending) resetActionStates();

      const btn = document.getElementById('btn-delete');
      const btnMob = document.getElementById('btn-delete-mobile');
      const msg = document.getElementById('action-confirm-msg');

      if (!deletePending) {
        deletePending = true;
        msg.classList.remove('hidden');
        msg.classList.add('border-red-200', 'text-red-500');
        msg.innerHTML = 'âš ï¸ æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ<br>ï¼ˆã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ï¼‰';

        btn.classList.add('bg-red-50', 'border-red-400');
        btnMob.classList.add('bg-red-500', 'text-white');
        btnMob.textContent = 'ç¢ºå®š';
        showToast('âš ï¸ ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨å‰Šé™¤');
        return;
      }

      if(editMode === 'draft') {
        await db.drafts.delete(currentId);
        showToast('ğŸ—‘ï¸ ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        createNew();
      } else {
        const table = editMode === 'header' ? db.headers : db.footers;
        await table.delete(currentId);
        showToast('ğŸ—‘ï¸ è¨­å®šã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        currentId = null;
        quill.root.innerHTML = '';
        document.getElementById('input-hf-name').value = '';
        setEditorUI(editMode, false);
        loadSettingsList();
        updateDropdowns();
      }
      resetActionStates();
    }

    async function duplicateCurrentItem() {
      if(!currentId) return;

      if(deletePending) resetActionStates();

      const btn = document.getElementById('btn-duplicate');
      const btnMob = document.getElementById('btn-duplicate-mobile');
      const msg = document.getElementById('action-confirm-msg');

      if (!duplicatePending) {
        duplicatePending = true;
        msg.classList.remove('hidden');
        msg.classList.add('border-cyan-200', 'text-cyan-600');
        msg.innerHTML = 'è¤‡è£½ã—ã¾ã™ã‹ï¼Ÿ<br>ï¼ˆã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ï¼‰';

        btn.classList.add('bg-cyan-100', 'border-cyan-500');
        btn.textContent = 'ç¢ºå®š';
        btnMob.classList.add('bg-cyan-500', 'text-white');
        btnMob.textContent = 'ç¢ºå®š';
        showToast('ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨è¤‡è£½');
        return;
      }

      const table = (editMode === 'draft') ? db.drafts : (editMode === 'header' ? db.headers : db.footers);
      const original = await table.get(currentId);
      
      if(original) {
        const nowObj = new Date();
        const displayDate = nowObj.toLocaleString('ja-JP'); 
        const sortDate = nowObj.toISOString();

        const newItem = { ...original };
        delete newItem.id;
        newItem.createdAt = sortDate;
        newItem.sortDate = sortDate;
        newItem.updatedAt = displayDate;
        
        if(newItem.subject) newItem.subject += " ã®ã‚³ãƒ”ãƒ¼";
        if(newItem.name) newItem.name += " ã®ã‚³ãƒ”ãƒ¼";

        const newId = await table.add(newItem);
        showToast('âœ¨ è¤‡è£½ã—ã¾ã—ãŸï¼');

        if(editMode === 'draft') {
          loadDraft(newId);
        } else {
          loadHFEditor(editMode, newId);
          updateDropdowns();
        }
      }
      resetActionStates();
    }

    // --- 9. ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–° & ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–° ---
    async function updateDropdowns() {
      let headers = await db.headers.toArray();
      let footers = await db.footers.toArray();
      
      headers = sortByCreatedAt(headers);
      footers = sortByCreatedAt(footers);

      const hSelect = document.getElementById('select-header');
      const fSelect = document.getElementById('select-footer');
      const currentH = hSelect.value;
      const currentF = fSelect.value;

      hSelect.innerHTML = '<option value="">ï¼ˆé¸æŠãªã—ï¼‰</option>';
      fSelect.innerHTML = '<option value="">ï¼ˆé¸æŠãªã—ï¼‰</option>';

      headers.forEach(h => {
        const opt = document.createElement('option');
        opt.value = h.id;
        opt.textContent = h.name;
        hSelect.appendChild(opt);
      });
      footers.forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.id;
        opt.textContent = f.name;
        fSelect.appendChild(opt);
      });

      hSelect.value = currentH;
      fSelect.value = currentF;
      
      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ›´æ–°å¾Œã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚æ›´æ–°
      await updateHFCache();
    }

    // â˜…â˜…â˜… ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°é–¢æ•° â˜…â˜…â˜…
    async function updateHFCache() {
       const hId = document.getElementById('select-header').value;
       const fId = document.getElementById('select-footer').value;

       cachedHeaderContent = '';
       cachedFooterContent = '';

       if(hId && hId !== "") {
         const h = await db.headers.get(parseInt(hId));
         if(h) cachedHeaderContent = h.content;
       }
       if(fId && fId !== "") {
         const f = await db.footers.get(parseInt(fId));
         if(f) cachedFooterContent = f.content;
       }
    }

    // --- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºåˆ¶å¾¡ ---
    let statusTimer = null;
    const statusEl = document.getElementById('status-msg');

    function updateHeaderStatus(msg, autoHide = false) {
      if (!statusEl) return;
      if (statusTimer) clearTimeout(statusTimer);
      
      statusEl.textContent = msg;
      
      if(msg) {
        statusEl.classList.remove('opacity-0'); 
      } else {
        statusEl.classList.add('opacity-0');
        return;
      }

      if (autoHide) {
        statusTimer = setTimeout(() => {
          statusEl.classList.add('opacity-0');
        }, 1500);
      }
    }

    // --- 10. è‡ªå‹•ä¿å­˜ ---
    async function autoSave() {
      if (deletePending || duplicatePending) return;

      const content = quill.root.innerHTML;
      const nowObj = new Date();
      const displayDate = nowObj.toLocaleString('ja-JP'); 
      const sortDate = nowObj.toISOString(); 

      if(editMode === 'draft') {
        const subject = document.getElementById('input-subject').value;
        const text = quill.getText().trim();
        
        if (currentId && subject === lastSavedSnapshot.subject && content === lastSavedSnapshot.content) {
          updateHeaderStatus('â˜ï¸ ä¿å­˜æ¸ˆã¿', true);
          return; 
        }

        if (!currentId && !subject && text.length === 0) {
           updateHeaderStatus('', false); 
           return;
        }
        
        const data = { subject, content, sortDate, updatedAt: displayDate };
        
        if (currentId) {
          await db.drafts.update(currentId, data);
        } else {
          data.createdAt = sortDate; // æ–°è¦
          currentId = await db.drafts.add(data);
          setEditorUI('draft', true); 
        }
        
        lastSavedSnapshot = { subject, content, name: '' };
        loadDraftList();

      } else {
        const name = document.getElementById('input-hf-name').value || 'åç§°æœªè¨­å®š';
        
        if (currentId && name === lastSavedSnapshot.name && content === lastSavedSnapshot.content) {
          updateHeaderStatus('â˜ï¸ ä¿å­˜æ¸ˆã¿', true);
          return;
        }

        const table = editMode === 'header' ? db.headers : db.footers;
        const data = { name, content, sortDate, updatedAt: displayDate };
        
        if (currentId) {
          await table.update(currentId, data);
        } else {
          data.createdAt = sortDate; // æ–°è¦
          const newId = await table.add(data);
          currentId = newId;
          setEditorUI(editMode, true);
        }

        lastSavedSnapshot = { subject: '', content, name };
        loadSettingsList();
        updateDropdowns();
      }
      
      updateHeaderStatus('â˜ï¸ è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ', true);
    }

    // --- 11. ä¾¿åˆ©æ©Ÿèƒ½ (ã‚³ãƒ”ãƒ¼ãƒ»Zipãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—) ---
    function stripHtml(html) {
      const tmp = document.createElement("DIV");
      let text = html.replace(/<br\s*\/?>/gi, '\n');
      text = text.replace(/<\/p>/gi, '\n');
      text = text.replace(/<\/div>/gi, '\n');
      tmp.innerHTML = text;
      return tmp.innerText || tmp.textContent || "";
    }

    // ã€ä¿®æ­£ã€‘ç¢ºå®Ÿãªã‚³ãƒ”ãƒ¼ã®ãŸã‚ã®é–¢æ•°
    function forceCopyToClipboard(text) {
      const textArea = document.createElement("textarea");
      textArea.value = text;
      textArea.style.position = "fixed";
      textArea.style.left = "-9999px";
      textArea.style.top = "0";
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        const successful = document.execCommand('copy');
        if(successful) {
           showToast('ğŸ“‹ ã‚³ãƒ”ãƒ¼æˆåŠŸï¼');
        } else {
           showToast('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—');
        }
      } catch (err) {
        showToast('âŒ ã‚¨ãƒ©ãƒ¼: ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
      document.body.removeChild(textArea);
    }

    // HTMLã®å„è¡Œã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’é©ç”¨ã™ã‚‹é–¢æ•°
    function applyStylesToLines(html, fontSize) {
       const div = document.createElement('div');
       div.innerHTML = html;
       const targets = div.querySelectorAll('p, li, h1, h2, h3, blockquote');
       targets.forEach(el => {
           // ã™ã§ã«ã‚¯ãƒ©ã‚¹æŒ‡å®š(ql-size-largeç­‰)ã‚„ç›´æ¥ã‚¹ã‚¿ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„
           const hasClass = Array.from(el.classList).some(c => c.startsWith('ql-size'));
           const hasStyle = el.style.fontSize;
           
           if (!hasClass && !hasStyle) {
               el.style.fontSize = fontSize;
           }
       });
       return div.innerHTML;
    }

    // HTMLã‚³ãƒ”ãƒ¼ (åŒæœŸå‡¦ç†ã«å¤‰æ›´)
    function copyHtml() {
      const body = quill.root.innerHTML;
      let innerHtml = `${cachedHeaderContent}\n${body}\n${cachedFooterContent}`;

      const nameMode = document.getElementById('select-name-convert').value;
      if (nameMode === 'convert') {
        innerHtml = innerHtml.replaceAll('ã‚ãªãŸ', '{{nickname}}ã•ã‚“');
      }

      // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºé©ç”¨
      const currentFontSize = localStorage.getItem('editor-font-size') || '16px';
      const finalHtml = applyStylesToLines(innerHtml, currentFontSize);

      forceCopyToClipboard(finalHtml);
    }

    // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼ (åŒæœŸå‡¦ç†ã«å¤‰æ›´)
    function copyTextOnly() {
      const body = quill.getText();
      const textHeader = stripHtml(cachedHeaderContent);
      const textFooter = stripHtml(cachedFooterContent);
      
      let finalString = `${textHeader}\n\n${body}\n\n${textFooter}`;
      finalString = finalString.replace(/^\n+/, '').replace(/\n+$/, '');

      const nameMode = document.getElementById('select-name-convert').value;
      if (nameMode === 'convert') {
        finalString = finalString.replaceAll('ã‚ãªãŸ', '{{nickname}}ã•ã‚“');
      }

      forceCopyToClipboard(finalString);
    }

    function copyBodyOnly() {
      const body = quill.root.innerHTML;
      forceCopyToClipboard(body);
    }

    async function downloadAllDraftsAsZip() {
      if(!confirm('ã™ã¹ã¦ã®ä¸‹æ›¸ãã‚’zipãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) return;

      const drafts = await db.drafts.orderBy('sortDate').reverse().toArray();
      if(drafts.length === 0) {
        showToast('âš ï¸ ä¿å­˜ã™ã‚‹ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const zip = new JSZip();
      const usedNames = {};

      drafts.forEach(d => {
        let filename = (d.subject || 'ç„¡é¡Œ').replace(/[\\/:*?"<>|]/g, '_');
        if (usedNames[filename]) {
          usedNames[filename]++;
          filename = `${filename}(${usedNames[filename]})`;
        } else {
          usedNames[filename] = 1;
        }
        const bodyText = stripHtml(d.content);
        const targetDate = d.createdAt || d.sortDate;
        const dateStr = formatDate(targetDate);
        
        const fileContent = `ä»¶å: ${d.subject}\næ—¥ä»˜: ${dateStr}\n\n${bodyText}`;
        zip.file(`${filename}.txt`, fileContent);
      });

      zip.generateAsync({type:"blob"}).then(function(content) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = `ãƒ¡ãƒ«ãƒã‚¬ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—_${new Date().toLocaleDateString().replace(/\//g,'-')}.zip`;
        a.click();
        showToast('ğŸ“¦ zipä½œæˆå®Œäº†ï¼');
      });
    }

    // ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
    async function exportData() {
      if(!confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;
      const drafts = await db.drafts.toArray();
      const headers = await db.headers.toArray();
      const footers = await db.footers.toArray();
      const theme = localStorage.getItem('editor-theme') || 'pink';
      const fontSize = localStorage.getItem('editor-font-size') || '16px';
      
      const data = { version: '1.4', date: new Date().toISOString(), theme, fontSize, drafts, headers, footers };
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mailcopy_backup_${new Date().toLocaleDateString().replace(/\//g,'')}.json`;
      a.click();
      showToast('ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†');
    }

    async function importData(input) {
      const file = input.files[0];
      if(!file) return;
      if(!confirm('âš ï¸ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        input.value = ''; return;
      }
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = JSON.parse(e.target.result);
          await db.transaction('rw', db.drafts, db.headers, db.footers, async () => {
            await db.drafts.clear(); await db.headers.clear(); await db.footers.clear();
            if(data.drafts) await db.drafts.bulkAdd(data.drafts);
            if(data.headers) await db.headers.bulkAdd(data.headers);
            if(data.footers) await db.footers.bulkAdd(data.footers);
          });
          if(data.theme) setTheme(data.theme);
          if(data.fontSize) changeBaseFontSize(data.fontSize);
          
          showToast('âœ… å¾©å…ƒå®Œäº†ï¼');
          setTimeout(() => location.reload(), 1000);
        } catch(err) {
          alert('èª­ã¿è¾¼ã¿å¤±æ•—');
        }
      };
      reader.readAsText(file);
    }

    // --- ãƒˆãƒªã‚¬ãƒ¼è¨­å®š (å…¥åŠ›æ¤œçŸ¥) ---
    const triggerSave = () => {
      clearTimeout(autoSaveTimer);
      updateHeaderStatus('âœï¸ åŸ·ç­†ä¸­...');
      autoSaveTimer = setTimeout(autoSave, 1000);
    };

    quill.on('text-change', function(delta, oldDelta, source) {
      if (source === 'user') triggerSave();
    });
    
    document.getElementById('input-subject').addEventListener('input', triggerSave);
    document.getElementById('input-hf-name').addEventListener('input', triggerSave);
    document.getElementById('search-input').addEventListener('input', loadDraftList);
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ : ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¤‰æ›´æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥å³æ›´æ–°
    document.getElementById('select-header').addEventListener('change', updateHFCache);
    document.getElementById('select-footer').addEventListener('change', updateHFCache);

    // åˆæœŸãƒ­ãƒ¼ãƒ‰
    switchTab('drafts');
  </script>
</body>
</html>
